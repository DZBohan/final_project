---
title: "R Notebook"
output: html_notebook

5.1 Using R to build dataframe.
```{r}
x_merge=NULL
i<-list.files()

for(n in i){
  x=read.delim(n,col.names = c('ID',substr(n,1,9)))
  if(is.null(x_merge)){
    x_merge=x
  }
  else{
    x_merge=merge(x_merge,x,by='ID')
  }
}

rownames(x_merge)<-x_merge$ID
```

5.2 Delete unnecessary rows and columns.
```{r}
x_reduce=x_merge[-(1:5),]

x_reduce=x_reduce[,-1]
```

5.3 Convert Counts file name to TCGA data number and remove the version number of the gene Ensembl number
```{r}
library(rjson)
x = fromJSON(file='metadata.cart.2021-11-09_lower.json')
n = ncol(x_reduce)
id=rep(0,n)
sample_id = rep(0,n)
for(i in 1:n){
  id[1]=x[[i]]$submitter_id
  sample_id[i]=x[[i]]$associated_entities[[1]]$entity_submitter_id
}
sample_matrix = data.frame(id=id,sample_id=sample_id)
sample_info = data.frame(id=substr(id,1,9),sample_id)
colnames(x_reduce)=sample_info$sample_id
xb=rownames(x_reduce)
xc <- gsub("\\.(\\.?\\d*)","",xb)
rownames(x_reduce)= xc
rownames(x_reduce)
colnames(x_reduce)
```

5.4 Change Ensembl number of gene in dataframe to gene id
```{r}
RawCounts <- x_reduce
Ensembl_ID <- data.frame(Ensembl_ID = row.names(RawCounts))
rownames(Ensembl_ID) <- Ensembl_ID[,1]
RawCounts <- cbind(Ensembl_ID,RawCounts)
```

```{r}
get_map = function(input) {
  if (is.character(input)) {
    if(!file.exists(input)) stop("Bad input file.")
    message("Treat input as file")
    input = data.table::fread(input, header = FALSE)
  } else {
    data.table::setDT(input)
  }
  
  input = input[input[[3]] == "gene", ]
  
  pattern_id = ".*gene_id \"([^;]+)\";.*"
  pattern_name = ".*gene_name \"([^;]+)\";.*"
  
  gene_id = sub(pattern_id, "\\1",input[[9]])
  gene_name = sub(pattern_name, "\\1", input[[9]])
  
  Ensembl_ID_TO_Genename <- data.frame(gene_id = gene_id, gene_name = gene_name, stringsAsFactors = FALSE)
  return(Ensembl_ID_TO_Genename)
}
Ensembl_ID_TO_Genename <- get_map("gencode.v38.basic.annotation.gtf")

gtf_Ensembl_ID <- substr(Ensembl_ID_TO_Genename[,1],1,15)
Ensembl_ID_TO_Genename <- data.frame(gtf_Ensembl_ID, Ensembl_ID_TO_Genename[,2])
colnames(Ensembl_ID_TO_Genename) <- c("Ensembl_ID","gene_id")
write.csv(Ensembl_ID_TO_Genename,file = "Ensembl_ID_TO_Genename.csv")
```

```{r}
mergeRawCounts <-merge(Ensembl_ID_TO_Genename,RawCounts,by="Ensembl_ID")
```

5.5 Removal of id duplicate genes
```{r}
mergeRawCounts <-mergeRawCounts[order(mergeRawCounts[,"gene_id"]),]
index <- duplicated(mergeRawCounts$gene_id)
mergeRawCounts <- mergeRawCounts[!index,]
rownames(mergeRawCounts) <- mergeRawCounts[,"gene_id"]
LUAD_Counts_lower <- mergeRawCounts[,-c(1:2)]
```

5.4 Deleting unwanted count files in dataframe
```{r}
Counts_lower <- within(LUAD_Counts_lower, rm("TCGA-21-1076-01A-02R-0692-07","TCGA-43-6143-11A-01R-1820-07","TCGA-44-3398-11B-01R-1758-07","TCGA-44-6148-11A-01R-1858-07","TCGA-56-7580-11A-01R-2045-07","TCGA-56-7582-11A-01R-2045-07","TCGA-56-8309-11A-01R-2296-07","TCGA-91-6828-11A-01R-1858-07","TCGA-91-6835-11A-01R-1858-07","TCGA-91-6847-11A-01R-1949-07"))
write.csv(Counts_lower,file="Counts_lower.csv")